<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pivot to Flat File Converter</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .upload-area {
            border: 2px dashed #007bff;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            margin-bottom: 20px;
            background-color: #f8f9fa;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .upload-area:hover {
            border-color: #0056b3;
            background-color: #e3f2fd;
        }
        .upload-area.dragover {
            border-color: #28a745;
            background-color: #d4edda;
        }
        input[type="file"] {
            display: none;
        }
        .btn {
            background-color: #007bff;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
            transition: background-color 0.3s;
        }
        .btn:hover {
            background-color: #0056b3;
        }
        .btn:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        .preview {
            margin-top: 20px;
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .preview table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }
        .preview th, .preview td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        .preview th {
            background-color: #f8f9fa;
            font-weight: bold;
        }
        .status {
            margin: 15px 0;
            padding: 10px;
            border-radius: 5px;
            font-weight: bold;
        }
        .status.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status.info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .options {
            margin: 20px 0;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 5px;
        }
        .options label {
            display: block;
            margin: 10px 0;
            font-weight: bold;
        }
        .options input, .options select {
            margin-left: 10px;
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 3px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìä Pivot Table to Flat File Converter</h1>
        
        <div class="upload-area" onclick="document.getElementById('fileInput').click()">
            <p>üìÅ Click here to select your Excel file or drag and drop it</p>
            <p style="color: #666; font-size: 14px;">Supports .xlsx and .xls files</p>
        </div>
        
        <input type="file" id="fileInput" accept=".xlsx,.xls" />
        
        <div class="options">
            <h3>Output Options</h3>
            <label>
                Delimiter: 
                <select id="delimiter">
                    <option value="|">Pipe (|)</option>
                    <option value=",">Comma (,)</option>
                    <option value="\t">Tab</option>
                    <option value=";">Semicolon (;)</option>
                </select>
            </label>
            <label>
                <input type="checkbox" id="includeZeros" checked> Include rows with zero quantities
            </label>
            <label>
                Date Format: 
                <select id="dateFormat">
                    <option value="original">Keep Original</option>
                    <option value="yyyy-mm-dd">YYYY-MM-DD</option>
                    <option value="mm/dd/yyyy">MM/DD/YYYY</option>
                    <option value="dd/mm/yyyy">DD/MM/YYYY</option>
                </select>
            </label>
        </div>
        
        <div id="status"></div>
        
        <div id="preview"></div>
        
        <button class="btn" id="downloadBtn" onclick="downloadFile()" disabled>üì• Download Converted File</button>
    </div>

    <script>
        let convertedData = '';
        let originalFilename = '';

        // File upload handling
        document.getElementById('fileInput').addEventListener('change', handleFile);
        
        // Drag and drop handling
        const uploadArea = document.querySelector('.upload-area');
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });
        
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });
        
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                processFile(files[0]);
            }
        });

        function handleFile(event) {
            const file = event.target.files[0];
            if (file) {
                processFile(file);
            }
        }

        function processFile(file) {
            originalFilename = file.name.replace(/\.[^/.]+$/, ""); // Remove extension
            showStatus('Processing file...', 'info');
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    
                    // Get the first sheet
                    const sheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[sheetName];
                    
                    // Convert to JSON format preserving the structure
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, {
                        header: 1, // Use array of arrays format
                        raw: false // Get formatted strings
                    });
                    
                    convertPivotToFlat(jsonData);
                    
                } catch (error) {
                    showStatus('Error reading file: ' + error.message, 'error');
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function convertPivotToFlat(data) {
            if (data.length < 2) {
                showStatus('File appears to be empty or has insufficient data', 'error');
                return;
            }
            
            const includeZeros = document.getElementById('includeZeros').checked;
            const delimiter = document.getElementById('delimiter').value;
            const dateFormat = document.getElementById('dateFormat').value;
            
            // First row contains dates (skip first column which is part codes header)
            const dates = data[0].slice(1);
            
            // Rest of the rows contain part codes and quantities
            const flatData = [];
            const header = ['PartCode', 'Date', 'Quantity'];
            flatData.push(header.join(delimiter));
            
            for (let i = 1; i < data.length; i++) {
                const row = data[i];
                const partCode = row[0];
                
                if (!partCode) continue; // Skip empty rows
                
                // Process each date column
                for (let j = 1; j < row.length && j <= dates.length; j++) {
                    const quantity = row[j] || 0;
                    const date = dates[j - 1];
                    
                    // Skip if quantity is 0 and user doesn't want zeros
                    if (!includeZeros && (quantity == 0 || quantity === '')) continue;
                    
                    // Format date if requested
                    let formattedDate = date;
                    if (dateFormat !== 'original' && date) {
                        formattedDate = formatDate(date, dateFormat);
                    }
                    
                    flatData.push([partCode, formattedDate, quantity].join(delimiter));
                }
            }
            
            convertedData = flatData.join('\n');
            
            showStatus(`Successfully converted! Found ${flatData.length - 1} records.`, 'success');
            showPreview(flatData.slice(0, 21)); // Show first 20 rows + header
            document.getElementById('downloadBtn').disabled = false;
        }

        function formatDate(dateStr, format) {
            if (!dateStr) return dateStr;
            
            // Try to parse the date string
            let date;
            
            // Handle various date formats that might come from Excel
            if (dateStr.includes('-')) {
                // Format like "04-Aug-24" or "26-Jan-25"
                const parts = dateStr.split('-');
                if (parts.length === 3) {
                    const day = parts[0];
                    const month = parts[1];
                    const year = parts[2].length === 2 ? '20' + parts[2] : parts[2];
                    
                    // Convert month name to number
                    const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun',
                                      'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                    const monthNum = monthNames.indexOf(month) + 1;
                    
                    if (monthNum > 0) {
                        date = new Date(year, monthNum - 1, day);
                    }
                }
            }
            
            if (!date || isNaN(date)) {
                // Try direct parsing
                date = new Date(dateStr);
            }
            
            if (isNaN(date)) {
                return dateStr; // Return original if we can't parse it
            }
            
            // Format according to user preference
            switch (format) {
                case 'yyyy-mm-dd':
                    return date.getFullYear() + '-' + 
                           String(date.getMonth() + 1).padStart(2, '0') + '-' + 
                           String(date.getDate()).padStart(2, '0');
                case 'mm/dd/yyyy':
                    return String(date.getMonth() + 1).padStart(2, '0') + '/' + 
                           String(date.getDate()).padStart(2, '0') + '/' + 
                           date.getFullYear();
                case 'dd/mm/yyyy':
                    return String(date.getDate()).padStart(2, '0') + '/' + 
                           String(date.getMonth() + 1).padStart(2, '0') + '/' + 
                           date.getFullYear();
                default:
                    return dateStr;
            }
        }

        function showStatus(message, type) {
            const statusDiv = document.getElementById('status');
            statusDiv.innerHTML = message;
            statusDiv.className = 'status ' + type;
        }

        function showPreview(data) {
            const previewDiv = document.getElementById('preview');
            
            if (data.length === 0) {
                previewDiv.innerHTML = '<p>No data to preview</p>';
                return;
            }
            
            const delimiter = document.getElementById('delimiter').value;
            let table = '<table><thead><tr>';
            
            // Header row
            const headers = data[0].split(delimiter);
            headers.forEach(header => {
                table += '<th>' + escapeHtml(header) + '</th>';
            });
            table += '</tr></thead><tbody>';
            
            // Data rows (skip header)
            for (let i = 1; i < Math.min(data.length, 21); i++) {
                const row = data[i].split(delimiter);
                table += '<tr>';
                row.forEach(cell => {
                    table += '<td>' + escapeHtml(cell) + '</td>';
                });
                table += '</tr>';
            }
            
            table += '</tbody></table>';
            
            if (data.length > 21) {
                table += '<p style="text-align: center; color: #666; margin-top: 10px;">... and ' + (data.length - 21) + ' more rows</p>';
            }
            
            previewDiv.innerHTML = '<h3>Preview (first 20 rows)</h3>' + table;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function downloadFile() {
            if (!convertedData) {
                showStatus('No data to download', 'error');
                return;
            }
            
            const blob = new Blob([convertedData], { type: 'text/plain' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = originalFilename + '_converted.txt';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            showStatus('File downloaded successfully!', 'success');
        }
    </script>
</body>
</html>
