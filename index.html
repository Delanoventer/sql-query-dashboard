<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Excel to CSV with Date Formatting</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            border-radius: 8px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            margin-bottom: 30px;
        }
        .upload-area {
            border: 2px dashed #ddd;
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            margin-bottom: 20px;
            background-color: #fafafa;
        }
        .upload-area.dragover {
            border-color: #4CAF50;
            background-color: #f0f8f0;
        }
        input[type="file"] {
            margin: 20px 0;
        }
        .results {
            margin-top: 30px;
        }
        .info {
            background-color: #e7f3ff;
            border: 1px solid #b3d9ff;
            border-radius: 4px;
            padding: 15px;
            margin-bottom: 20px;
        }
        .success {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            border-radius: 4px;
            padding: 15px;
            margin-bottom: 20px;
            color: #155724;
        }
        .download-btn {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin-right: 10px;
        }
        .download-btn:hover {
            background-color: #45a049;
        }
        .preview {
            background-color: #f9f9f9;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 15px;
            font-family: monospace;
            max-height: 300px;
            overflow: auto;
            white-space: pre-wrap;
            font-size: 12px;
        }
        .stats {
            font-size: 14px;
            color: #666;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Excel to CSV Converter with Column J Date Formatting</h1>
        
        <div class="info">
            <strong>Purpose:</strong> This tool will convert your Excel file to a comma-delimited CSV file, formatting the dates in Column J (date2) to YYYY-MM-DD format while keeping all other data unchanged.
        </div>

        <div class="upload-area" id="uploadArea">
            <p>Drag and drop your Excel file here, or click to select</p>
            <input type="file" id="fileInput" accept=".xlsx,.xls" style="display: none;">
            <button onclick="document.getElementById('fileInput').click()" style="padding: 10px 20px; background-color: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer;">Choose File</button>
        </div>

        <div id="results" class="results" style="display: none;"></div>
    </div>

    <script>
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const results = document.getElementById('results');
        let processedData = null;

        // Handle drag and drop
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const file = e.dataTransfer.files[0];
            if (file) {
                processFile(file);
            }
        });

        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                processFile(file);
            }
        });

        function formatDate(dateValue) {
            if (!dateValue) return dateValue;
            
            let date;
            
            if (dateValue instanceof Date) {
                date = dateValue;
            } else if (typeof dateValue === 'string') {
                const str = dateValue.trim();
                
                // Handle dd/mm/yyyy format
                if (/^\d{1,2}\/\d{1,2}\/\d{4}$/.test(str)) {
                    const parts = str.split('/');
                    const day = parseInt(parts[0], 10);
                    const month = parseInt(parts[1], 10) - 1; // JS months are 0-based
                    const year = parseInt(parts[2], 10);
                    date = new Date(year, month, day);
                }
                // Handle dd-mm-yyyy format
                else if (/^\d{1,2}-\d{1,2}-\d{4}$/.test(str)) {
                    const parts = str.split('-');
                    const day = parseInt(parts[0], 10);
                    const month = parseInt(parts[1], 10) - 1;
                    const year = parseInt(parts[2], 10);
                    date = new Date(year, month, day);
                }
                // Handle yyyy-mm-dd format (already correct, but parse to validate)
                else if (/^\d{4}-\d{1,2}-\d{1,2}$/.test(str)) {
                    date = new Date(str);
                }
                // Handle ISO format like "2025-07-25T22:00:00.000Z"
                else if (str.includes('T') || str.includes('Z')) {
                    date = new Date(str);
                }
                // Handle mm/dd/yyyy format (less common but possible)
                else if (/^\d{1,2}\/\d{1,2}\/\d{4}$/.test(str)) {
                    // This is ambiguous with dd/mm/yyyy, but we'll try standard Date parsing
                    // which assumes mm/dd/yyyy for US format
                    const testDate = new Date(str);
                    if (!isNaN(testDate.getTime())) {
                        // Check if day > 12, then it's likely dd/mm/yyyy
                        const parts = str.split('/');
                        const firstNum = parseInt(parts[0], 10);
                        const secondNum = parseInt(parts[1], 10);
                        
                        if (firstNum > 12 && secondNum <= 12) {
                            // Definitely dd/mm/yyyy
                            const day = firstNum;
                            const month = secondNum - 1;
                            const year = parseInt(parts[2], 10);
                            date = new Date(year, month, day);
                        } else {
                            date = testDate;
                        }
                    }
                }
                // Try generic Date parsing as fallback
                else {
                    date = new Date(str);
                }
            } else if (typeof dateValue === 'number') {
                // Excel serial date number
                date = new Date((dateValue - 25569) * 86400 * 1000);
            } else {
                return dateValue;
            }

            if (isNaN(date.getTime())) {
                console.warn('Could not parse date:', dateValue);
                return dateValue; // Return original if we can't parse it
            }

            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            
            return `${year}-${month}-${day}`;
        }

        function escapeCsvValue(value) {
            if (value === null || value === undefined) return '';
            const str = String(value);
            // Escape quotes and wrap in quotes if contains comma, quote, or newline
            if (str.includes(',') || str.includes('"') || str.includes('\n') || str.includes('\r')) {
                return '"' + str.replace(/"/g, '""') + '"';
            }
            return str;
        }

        function downloadCsv(csvContent, filename) {
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function processFile(file) {
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { 
                        type: 'array',
                        cellDates: true
                    });
                    
                    const sheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[sheetName];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                    
                    if (jsonData.length === 0) {
                        results.innerHTML = '<p>No data found in the Excel file.</p>';
                        results.style.display = 'block';
                        return;
                    }
                    
                    const headers = jsonData[0];
                    const dataRows = jsonData.slice(1);
                    
                    // Find column J (index 9)
                    const columnJHeader = headers[9];
                    
                    let csvOutput = '';
                    let formattedDatesCount = 0;
                    
                    // Add headers
                    csvOutput += headers.map(header => escapeCsvValue(header)).join(',') + '\n';
                    
                    // Process each data row
                    let unformattedDates = [];
                    for (let i = 0; i < dataRows.length; i++) {
                        const row = [...dataRows[i]]; // Copy the row
                        
                        // Format column J (index 9)
                        if (row[9]) {
                            const originalValue = row[9];
                            const formattedValue = formatDate(row[9]);
                            if (formattedValue !== originalValue) {
                                formattedDatesCount++;
                            } else if (originalValue && !originalValue.match(/^\d{4}-\d{2}-\d{2}$/)) {
                                // Track values that couldn't be formatted and aren't already in correct format
                                unformattedDates.push({ row: i + 2, value: originalValue }); // +2 because of header and 0-based index
                            }
                            row[9] = formattedValue;
                        }
                        
                        // Convert row to CSV format
                        const csvRow = row.map(cell => escapeCsvValue(cell)).join(',');
                        csvOutput += csvRow + '\n';
                    }
                    
                    processedData = csvOutput;
                    
                    // Show results
                    const originalFileName = file.name.replace(/\.[^/.]+$/, "");
                    const csvFileName = `${originalFileName}_formatted.csv`;
                    
                    let resultsHTML = `
                        <div class="success">
                            <strong>✓ Processing Complete!</strong><br>
                            File: ${file.name}<br>
                            Total rows: ${dataRows.length}<br>
                            Column J (${columnJHeader}): ${formattedDatesCount} dates formatted to YYYY-MM-DD<br>
                            ${unformattedDates.length > 0 ? `⚠️ ${unformattedDates.length} values could not be formatted` : '✓ All dates successfully formatted'}
                        </div>
                        
                        ${unformattedDates.length > 0 ? `
                        <div class="info">
                            <strong>Unformatted values (first 10):</strong><br>
                            ${unformattedDates.slice(0, 10).map(item => `Row ${item.row}: "${item.value}"`).join('<br>')}
                            ${unformattedDates.length > 10 ? `<br>... and ${unformattedDates.length - 10} more` : ''}
                        </div>
                        ` : ''}
                        
                        <div>
                            <button class="download-btn" onclick="downloadCsv(processedData, '${csvFileName}')">
                                Download CSV File
                            </button>
                        </div>
                        
                        <div class="stats">
                            <strong>Preview (first 10 lines):</strong>
                        </div>
                        <div class="preview">${csvOutput.split('\n').slice(0, 10).join('\n')}</div>
                    `;
                    
                    results.innerHTML = resultsHTML;
                    results.style.display = 'block';
                    
                } catch (error) {
                    results.innerHTML = `<p style="color: red;">Error processing file: ${error.message}</p>`;
                    results.style.display = 'block';
                    console.error('Processing error:', error);
                }
            };
            
            reader.readAsArrayBuffer(file);
        }
    </script>
</body>
</html>
